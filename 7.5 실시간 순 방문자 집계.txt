
전체 방문자 수와 순 방문자 수를 저장하고 조회하는 기능을 3일 안에 구현
사용자 동향을 파악하고, 나아가서는 사이트 활성화 또는 마케팅을 위한 자료로 활용

페이지 뷰(Page View)는 줄여서 PV라고 하며 다른 말로는 일일 클릭수라고도 한다.

유니크 뷰(Unique View)는 줄여서 UV라고 하며 다른 말로 순 방문자수라고 한다.

순 방문자 수 누적 방문자 수

1. 웹 서비스 엑세스 로그를 분석하여 일일 클릭 수와 일일 순 방문자 수를 계산한다.
2. 구글 웹로그 분석
3. 로그 파일을 일별로 배치 프로그램으로 계산하기도 한다.

웹 로그 를 제외하면 정보를 실시간으로 조회할 수 없다.
웹 로그 분석 서비스도 서비스 제공자에 따라서 실시간 조회가 불가능한 경우도 있다.

순방문자
페이지 클릭수

요구사항

천만명의 회원을 가진 서비스에서 일일 방문자 횟수를 집계

순수 방문횟수 누적방문 횟수
날짜별로 저장

기능정의
- 사용자가 접속한 날짜의 누적 방문 횟수 저장
- 사용자가 접속한 날짜의 순 방문 횟수 저장
- 지정된 날짜의 누적 방문 횟수 조회
- 지정된 날짜의 순 방문 횟수 조회

setbit 명령어 사용

사용자 번호는 순차적이라는 가정하에 

unique:visitors:20230503 -> 00000001 00000000

첫번째 자리는 오프셋이라 제외

page:view:20230503
unqiue:visitors:20230503

일주일 단위로 확장

회원이 천만명이면 칠천만번의 레디스 명령을 호출
너무 비정상적인 접근 방법임

천만번 레디스 명령을 호출하려면 약 1분 이상 시간이 소요된다.


논리곱을 통해 알수 있다 예를들어서

10101010 & 11111111

10101010 이다.

bitop 명령으로 처리 할 수 있다.

1억 명의 사용자에 대한 주간 순 방문자 수를 계산하는 데 약 150
밀리초가 소요돼었으며 월간 순 방문자 수 계산에는 780밀리초가 소요됐다.
예제의 성능으로 유추하여 볼 때 실제 서비스에서 사용이 가능한 수준이다.

두 번째 추가 요구 사항
개근상 이벤트 
일주일 동안 하루도 빠지지 않고 로그인한 사용자를 대상으로 추첨을 통해서 경품지급
김대리는 새로운 일감이 생겨서 기분이 썩 좋지는 않았지만 bitop 연산으로 간단하게 해결되리라 생각

두 번째 추가 요구 사항을 위한 아이디어

천 만명의 사용자라면 다시 천만번의 레디스 명령을 호출해야 하는 상황이 발생한다.

레디스 서버에 부하를 주지 않으면서 각 비트의 값을 조회하는 방법은 두 가지다.
1. 자바로 레디스의 get 명령을 사용 전체 문자열 값을 조회한 다음 각 비트에 대한 값을 
조회하여 사용자 목록을 생성하는 것
2. 비트 조회 연산을 자바 언어가 실행되는 클라이언트 프로그램에서 실행 루아 스크립트를 사용하여
비트 연산을 수행

먼저 자바 언어의 구현 사용자가 1억 명의 하루 로그인 정보는 문자열 데이터로 12MB다.
자바로 비트연산을 처리할려면 12MB의 데이터를 네트워크를 통해서 전송받은 다음 비트연산을 수행해야 한다.
근데 여기서 일주일간의 데이터가 필요하므로 12*7에 해당하는 84MB의 데이터를 수신해야 한다.
즉 페이지를 조회할 때마다 84MB의 데이터 전송이 발생하게 된다.
사용자가 더 늘어나거나 이벤트 기간이 늘어난다면 더 많은 네트워크 트래픽이 필요하다.
그러므로 자바로 비트 연산을 구현하는 것은 매우 비효적이다.

레디스의 bitop 명령과 루아 스크립트를 사용한 구현 방법인 uv:event 키에 이벤트 대상자 정보가
담겨 있으며 그 값을 루아가 실행되는 인터프리터에서 비트연산을 사용하여 결과를 생성한다.

루아에서 서버로 getbit 명령을 천만 번 전송하는 것은 파이프라인을 사용한 명령 전송과 수행시간에 
크게 차이가 없기 때문이다.





